{% extends 'souffleApp/base.html' %}

{% block title %}Editar: {{ curso.title }}{% endblock %}

{% block content %}
<div class="edit-container">
  <h2 class="edit-title">Editar curso: {{ curso.title }}</h2>

    {% if messages %}
      <div class="messages">
        {% for message in messages %}
          <div class="message {{ message.tags }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="edit-form">
  {% csrf_token %}
  <h3 style="margin-top:0;">Información del curso</h3>
  {{ form.as_p }}
  {% if formset %}
        {{ formset.management_form }}
        <div class="horarios-list">
          {% for f in formset.forms %}
            <div class="horario-row">
              <div class="horario-hidden">
                {{ f.id }}
                {{ f.DELETE }}
              </div>

              <div class="horario-field">
                <label>Fecha</label>
                {{ f.fecha }}
              </div>

              <div class="horario-field">
                <label>Hora</label>
                {{ f.hora }}
              </div>

              <div class="horario-field horario-cupos">
                <label>Cupos</label>
                {{ f.cupos }}
              </div>

              <div class="horario-actions">
                {% if f.instance.pk %}
                  <span class="delete-marker">(existente)</span>
                {% endif %}
                <button type="button" class="remove-row">✖</button>
              </div>
            </div>
          {% endfor %}
        </div>

        <!-- template para agregar nuevas filas -->
        <div id="empty-form-template" style="display:none">
          <div class="horario-row">
            <div class="horario-hidden">
              {{ formset.empty_form.id }}
              {{ formset.empty_form.DELETE }}
            </div>
            <div class="horario-field">
              <label>Fecha</label>
              {{ formset.empty_form.fecha }}
            </div>
            <div class="horario-field">
              <label>Hora</label>
              {{ formset.empty_form.hora }}
            </div>
            <div class="horario-field horario-cupos">
              <label>Cupos</label>
              {{ formset.empty_form.cupos }}
            </div>
            <div class="horario-actions">
              <button type="button" class="remove-row">✖</button>
            </div>
          </div>
        </div>

        <div style="margin-bottom:12px;">
          <button type="button" id="add-horario" class="auth-btn" style="background:#6b21a8">+ Agregar horario</button>
        </div>
      {% endif %}

      <div style="display:flex; gap:12px; margin-top:12px;">
        <button type="submit" class="auth-btn">Guardar cambios</button>
        <a href="{% url 'curso_detail' curso.id %}" class="entry-btn">Cancelar</a>
      </div>
    </form>
</div>

<style>
.edit-container{
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items:flex-start;
    padding:28px;
    margin: 32px auto;
    max-width:900px;
    background: linear-gradient(135deg, #ffe4f3 0%, #f3e8ff 100%);
    border-radius:12px;
    box-shadow: 0 6px 24px rgba(210,145,188,0.08);
}
.edit-title{ color:#C93384; margin:0; font-size:1.6rem; font-weight:700 }
.messages .message{ padding:10px 12px; border-radius:8px; background:#fff4f8; color:#7a1736 }
.edit-form p{ margin:0 0 12px 0 }
.edit-form label{ display:block; margin-bottom:6px; font-weight:600 }
.edit-form input[type=text], .edit-form input[type=email], .edit-form input[type=number], .edit-form textarea, .edit-form select{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); font-size:1rem;
}
.auth-btn{ padding:0.7rem 1.1rem; border-radius:1rem; background:#e44f9c; color:#fff; border:none; cursor:pointer; font-weight:600 }
.auth-btn:hover{ background:#C93384 }
.entry-btn{ display:inline-block; padding:0.7rem 1.1rem; border-radius:1rem; background:#e44f9c; color:#fff; text-decoration:none; font-weight:600 }
.entry-btn:hover{ background:#C93384 }
@media(max-width:720px){ .edit-container{ padding:18px; margin:18px } }

/* Horario formset styles */
.horarios-list{ display:flex; flex-direction:column; gap:8px; margin-bottom:8px }
.horario-row{ display:flex; gap:12px; align-items:center; padding:10px; background:var(--card, #fff); border-radius:8px; border:1px solid rgba(0,0,0,0.04) }
.horario-hidden{ display:none }
.horario-field{ flex:1; min-width:0 }
.horario-field label{ display:block; font-size:0.9rem; margin-bottom:6px; color:rgba(0,0,0,0.7) }
.horario-cupos{ width:120px }
.horario-actions{ width:80px; display:flex; align-items:center; justify-content:flex-end; gap:8px }
.remove-row{ background:transparent; border:none; color:#C93384; cursor:pointer; font-size:1rem }
.delete-marker{ font-size:0.85rem; color:rgba(0,0,0,0.5) }

@media(max-width:720px){ .horario-row{ flex-direction:column; align-items:stretch } .horario-actions{ justify-content:flex-start } }
</style>

<script>
  (function(){
    const addBtn = document.getElementById('add-horario');
    const list = document.querySelector('.horarios-list');
    const emptyTpl = document.getElementById('empty-form-template');
    const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');

    if(!totalFormsInput) return; // no formset present

    function getTotalForms(){ return parseInt(totalFormsInput.value||0); }
    function setTotalForms(n){ totalFormsInput.value = n; }

    function attachRemove(row){
      const btn = row.querySelector('.remove-row');
      if(!btn) return;
      btn.addEventListener('click', ()=>{
        // if row has delete checkbox, check it and hide
        const del = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
        if(del){ del.checked = true; row.style.display = 'none'; }
        else{ row.remove(); renumber(); }
      });
    }

    function renumber(){
      const rows = Array.from(list.querySelectorAll('.horario-row'));
      rows.forEach((row, i)=>{
        Array.from(row.querySelectorAll('input, select, textarea, label')).forEach(el=>{
          if(el.name) el.name = el.name.replace(/-\d+-/, '-'+i+'-');
          if(el.id) el.id = el.id.replace(/-\d+-/, '-'+i+'-');
          if(el.htmlFor) el.htmlFor = el.htmlFor.replace(/-\d+-/, '-'+i+'-');
        });
      });
      setTotalForms(rows.length);
    }

    // attach to existing rows
    if(list){ Array.from(list.querySelectorAll('.horario-row')).forEach(r=>attachRemove(r)); }

    if(addBtn && emptyTpl && list){
      addBtn.addEventListener('click', ()=>{
        const index = getTotalForms();
        let tplHtml = emptyTpl.innerHTML;
        tplHtml = tplHtml.replace(/__prefix__/g, index);
        const wrapper = document.createElement('div');
        wrapper.innerHTML = tplHtml;
        const newRow = wrapper.firstElementChild;
        list.appendChild(newRow);
        attachRemove(newRow);
        setTotalForms(index+1);
      });
    }
  })();
</script>

{% endblock %}